<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Rapportagecontrole</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg-light: linear-gradient(to bottom right, #f0f8ff, #eaf6ff);
      --bg-dark: #121212;
      --text-light: #333;
      --text-dark: #eee;
      --container-bg-light: #ffffff;
      --container-bg-dark: #1e1e1e;
      --primary: #007bff;
      --primary-hover: #1976D2;
      --danger: #dc3545;
      --success: #28a745;
      --warning: #ffc107;
      --info: #00BCD4;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      min-height: 100vh;
      padding: 1rem;
      transition: background 0.3s, color 0.3s;
    }

    /* ... existing code ... */
  </style>
</head>
<body>
  <div id="notification-container" class="notification-container"></div>
  
  <div id="promptOverlay" class="overlay">
    <div class="overlay-content">
      <button class="overlay-close" onclick="sluitOverlay()">×</button>
      <h3>Prompt kopiëren naar ChatGPT</h3>
      <div class="overlay-text">
        <p>Volg deze stappen:</p>
        <ol>
          <li>Klik op de knop hieronder om de prompt te kopiëren</li>
          <li>Klik op 'Open ChatGPT' om ChatGPT te openen</li>
          <li>Plak de prompt in ChatGPT met Ctrl+V (Windows) of ⌘+V (Mac)</li>
        </ol>
      </div>
      <div class="overlay-buttons">
        <button onclick="kopieerPrompt()" class="btn btn-primary">
          <span class="material-icons">content_copy</span>
          Kopieer Prompt
        </button>
        <button onclick="openChatGPTVanuitOverlay()" class="btn btn-success">
          <span class="material-icons">open_in_new</span>
          Open ChatGPT
        </button>
      </div>
      <div id="copyStatus" class="copy-status"></div>
    </div>
  </div>

  <div id="helpModal" class="help-modal">
    <!-- Help modal content -->
  </div>

  <div id="changelog-modal" class="help-modal">
    <!-- Changelog modal content -->
  </div>

  <script>
    // Globale state object
    window.globals = {
      huidigePrompt: "",
      permanenteTranscript: "",
      laatsteInterimTranscript: "",
      opnameStartTijd: null,
      opnameTijdTimer: null,
      isOffline: false,
      autoSaveTimeout: null,
      deelnemers: [],
      rapportages: {},
      huidigeDeelnemer: '',
      recognition: null,
      isOpnameActief: false
    };

    // End handler voor speech recognition
    if (globals.recognition) {
      globals.recognition.onend = function() {
        if (!globals.isOpnameActief) return;
      };
    }

    // Spraakherkenning functies
    function setupSpeechRecognition() {
      if (!isMobile) {
        try {
          globals.recognition.start();
        } catch (error) {
          console.error('Herstart fout:', error);
          stopOpname();
        }
      }
    }

    // Hulpfuncties
    function ensureDeelnemersArray() {
      if (!Array.isArray(globals.deelnemers)) {
        console.warn('Deelnemers was geen array, wordt gereset');
        globals.deelnemers = [];
      }
      return globals.deelnemers;
    }

    function debugLog(message, data) {
      console.log(`[Debug] ${message}:`, data);
    }

    function updateDeelnemersList() {
      ensureDeelnemersArray();
      
      debugLog('updateDeelnemersList aangeroepen', {
        huidigeDeelnemers: globals.deelnemers,
        aantalDeelnemers: globals.deelnemers.length
      });
      
      const select = document.getElementById('deelnemerSelect');
      if (!select) {
        console.error('deelnemerSelect element niet gevonden!');
        return;
      }
      
      select.innerHTML = '<option value="">Selecteer een deelnemer...</option>';
      
      globals.deelnemers.forEach(deelnemer => {
        const option = document.createElement('option');
        option.value = deelnemer;
        option.textContent = deelnemer;
        select.appendChild(option);
      });
      
      if (globals.huidigeDeelnemer && globals.deelnemers.includes(globals.huidigeDeelnemer)) {
        select.value = globals.huidigeDeelnemer;
      }
      
      debugLog('Deelnemerslijst bijgewerkt', {
        aantalOptiesInSelect: select.options.length,
        geselecteerdeWaarde: select.value
      });
    }

    function exporteerDeelnemers() {
      try {
        let csvContent = "Deelnemer;Observatie;Datum;Laatst bijgewerkt;Methode\n";
        
        globals.deelnemers.forEach(deelnemer => {
          const rapportages = globals.rapportages[deelnemer] || [];
          if (Array.isArray(rapportages) && rapportages.length > 0) {
            rapportages.forEach(rapportage => {
              const escapedTekst = rapportage.tekst ? rapportage.tekst.replace(/;/g, ',') : '';
              const datum = rapportage.datum ? new Date(rapportage.datum).toLocaleString('nl-NL') : '';
              const laatstBijgewerkt = rapportage.laatst_bijgewerkt ? 
                new Date(rapportage.laatst_bijgewerkt).toLocaleString('nl-NL') : '';
              
              csvContent += `${deelnemer};${escapedTekst};${datum};${laatstBijgewerkt};${rapportage.methode || ''}\n`;
            });
          } else {
            csvContent += `${deelnemer};;;;\n`;
          }
        });
        
        const blob = new Blob(["\ufeff" + csvContent], { 
          type: 'text/csv;charset=utf-8;' 
        });
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `deelnemers_export_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Deelnemerslijst succesvol geëxporteerd!', 'success');
      
      } catch (error) {
        console.error('Fout bij exporteren:', error);
        showNotification('Er ging iets mis bij het exporteren.', 'error');
      }
    }

    function importeerDeelnemers(input) {
      debugLog('importeerDeelnemers aangeroepen', { input });
      
      const file = input.files[0];
      if (!file) {
        showNotification('Geen bestand geselecteerd', 'warning');
        return;
      }

      if (!file.name.toLowerCase().endsWith('.csv')) {
        showNotification('Alleen CSV bestanden worden ondersteund. Sla je Excel bestand op als CSV.', 'warning');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let content = e.target.result;
          debugLog('Bestandsinhoud gelezen', { contentLength: content.length });
          
          if (content.charCodeAt(0) === 0xFEFF) {
            content = content.slice(1);
          }
          
          const regels = content.split(/\r?\n/).filter(regel => regel.trim());
          debugLog('Regels gevonden', { aantalRegels: regels.length, eersteRegel: regels[0] });
          
          if (regels.length === 0) {
            showNotification('Het bestand is leeg', 'warning');
            return;
          }

          const eersteRegel = regels[0];
          const scheidingsteken = eersteRegel.includes(';') ? ';' : ',';
          debugLog('Scheidingsteken gedetecteerd', { scheidingsteken });
          
          const headers = eersteRegel.split(scheidingsteken).map(h => h.trim().toLowerCase());
          debugLog('Headers gevonden', { headers });
          
          const heeftDeelnemer = headers.some(h => h === 'deelnemer' || h.includes('naam'));
          const heeftObservatie = headers.some(h => h === 'observatie' || h === 'rapportage' || h === 'tekst');
          
          if (!heeftDeelnemer) {
            showNotification('Geen kolom "Deelnemer" of "Naam" gevonden in het bestand', 'error');
            return;
          }

          const nieuweDeelnemers = new Set();
          const nieuweRapportages = {};
          
          for (let i = 1; i < regels.length; i++) {
            const regel = regels[i].trim();
            if (!regel) continue;
            
            const velden = regel.split(scheidingsteken).map(v => v.trim());
            debugLog(`Verwerken regel ${i}`, { velden });
            
            if (velden.length < 1) continue;
            
            const deelnemerIndex = headers.findIndex(h => h === 'deelnemer' || h.includes('naam'));
            const observatieIndex = headers.findIndex(h => h === 'observatie' || h === 'rapportage' || h === 'tekst');
            const datumIndex = headers.findIndex(h => h.includes('datum'));
            const methodeIndex = headers.findIndex(h => h === 'methode');
            
            const deelnemer = velden[deelnemerIndex];
            if (!deelnemer) continue;
            
            debugLog(`Deelnemer gevonden`, { deelnemer, veldIndex: deelnemerIndex });
            nieuweDeelnemers.add(deelnemer);
            
            if (!nieuweRapportages[deelnemer]) {
              nieuweRapportages[deelnemer] = [];
            }
            
            if (observatieIndex !== -1 && velden[observatieIndex]) {
              nieuweRapportages[deelnemer].push({
                tekst: velden[observatieIndex],
                datum: datumIndex !== -1 ? new Date(velden[datumIndex] || Date.now()).toISOString() : new Date().toISOString(),
                laatst_bijgewerkt: new Date().toISOString(),
                methode: methodeIndex !== -1 ? velden[methodeIndex] || 'objectief' : 'objectief'
              });
            }
          }

          globals.deelnemers = Array.from(nieuweDeelnemers);
          globals.rapportages = nieuweRapportages;
          
          saveToLocalStorage('deelnemers', globals.deelnemers);
          saveToLocalStorage('rapportages', globals.rapportages);
          
          updateDeelnemersList();
          showNotification('Import succesvol afgerond!', 'success');
          
        } catch (error) {
          console.error('Fout bij importeren:', error);
          showNotification('Er ging iets mis bij het importeren.', 'error');
        }
      };
      
      reader.readAsText(file);
    }

    function voegDeelnemerToe() {
      const naam = prompt("Voer de naam van de deelnemer in:");
      
      if (!naam) {
        showNotification("Geen naam ingevoerd", "warning");
        return;
      }

      const deelnemer = naam.trim();
      
      if (deelnemer.length < 2) {
        showNotification("De naam moet minimaal 2 karakters lang zijn", "warning");
        return;
      }

      if (deelnemer.length > 50) {
        showNotification("De naam mag niet langer zijn dan 50 karakters", "warning");
        return;
      }

      if (!/^[a-zA-Z0-9\s\-_.]+$/.test(deelnemer)) {
        showNotification("De naam mag alleen letters, cijfers, spaties, koppeltekens, punten en underscores bevatten", "warning");
        return;
      }
      
      debugLog('Nieuwe deelnemer toevoegen', { naam: deelnemer });
      
      ensureDeelnemersArray();
      
      if (globals.deelnemers.includes(deelnemer)) {
        showNotification("Deze deelnemer bestaat al", "warning");
        return;
      }
      
      try {
        if (globals.deelnemers.length >= 100) {
          showNotification("Maximum aantal deelnemers bereikt. Verwijder eerst enkele deelnemers.", "warning");
          return;
        }

        if (globals.deelnemers.length === 1 && globals.deelnemers[0] === 'Deelnemer') {
          globals.deelnemers = [];
          delete globals.rapportages['Deelnemer'];
        }

        globals.deelnemers.push(deelnemer);
        globals.rapportages[deelnemer] = [];
        
        if (!saveToLocalStorage('deelnemers', globals.deelnemers)) {
          throw new Error('Kon deelnemers niet opslaan');
        }
        if (!saveToLocalStorage('rapportages', globals.rapportages)) {
          throw new Error('Kon rapportages niet opslaan');
        }
        
        debugLog('Deelnemer toegevoegd aan localStorage', {
          deelnemers: globals.deelnemers
        });
        
        updateDeelnemersList();
        
        globals.huidigeDeelnemer = deelnemer;
        const select = document.getElementById('deelnemerSelect');
        if (select) {
          select.value = deelnemer;
          selecteerDeelnemer();
        }
        
        showNotification(`Deelnemer "${deelnemer}" succesvol toegevoegd!`, "success");
        
      } catch (error) {
        console.error('Fout bij toevoegen deelnemer:', error);
        showNotification('Er ging iets mis bij het toevoegen van de deelnemer. Probeer het opnieuw.', 'error');
        
        try {
          const index = globals.deelnemers.indexOf(deelnemer);
          if (index > -1) {
            globals.deelnemers.splice(index, 1);
          }
          delete globals.rapportages[deelnemer];
        } catch (rollbackError) {
          console.error('Fout bij terugdraaien wijzigingen:', rollbackError);
        }
      }
    }

    function selecteerDeelnemer() {
      const select = document.getElementById('deelnemerSelect');
      if (!select) {
        console.error('deelnemerSelect element niet gevonden!');
        return;
      }
      
      const nieuweDeelnemer = select.value;
      console.log('Selecteer deelnemer:', nieuweDeelnemer);
      
      if (globals.huidigeDeelnemer) {
        slaRapportageOp();
      }
      
      globals.huidigeDeelnemer = nieuweDeelnemer;
      
      toggleInputFields(nieuweDeelnemer);
      
      if (nieuweDeelnemer) {
        const rapportage = globals.rapportages[nieuweDeelnemer] || '';
        document.getElementById('input').value = rapportage;
        showNotification(`Rapportage van ${nieuweDeelnemer} geladen`, "info");
        
        document.getElementById('deelnemerVereistMelding').classList.remove('visible');
      } else {
        document.getElementById('input').value = '';
        document.getElementById('deelnemerVereistMelding').classList.add('visible');
      }
    }

    function toggleInputFields(deelnemer) {
      const inputElement = document.getElementById('input');
      const startOpnameBtn = document.getElementById('startOpname');
      const genBtn = document.getElementById('genBtn');
      const openChatGPTBtn = document.getElementById('openChatGPTBtn');
      const copyPromptBtn = document.getElementById('copyPromptBtn');
      const deelnemerVereistMelding = document.getElementById('deelnemerVereistMelding');
      const genAlleBtn = document.querySelector('button[onclick="genereerAllePrompts()"]');
      
      const heeftPrompt = globals.huidigePrompt && globals.huidigePrompt.trim() !== '';
      openChatGPTBtn.disabled = !heeftPrompt;
      copyPromptBtn.disabled = !heeftPrompt;
      
      if (deelnemer) {
        inputElement.disabled = false;
        startOpnameBtn.disabled = false;
        genBtn.disabled = !inputElement.value.trim();
        deelnemerVereistMelding.classList.remove('visible');
      } else {
        inputElement.disabled = true;
        startOpnameBtn.disabled = true;
        genBtn.disabled = true;
        deelnemerVereistMelding.classList.add('visible');
      }
      
      genAlleBtn.disabled = globals.deelnemers.length === 0;
    }

    function startOpname() {
      const heeftMeerdereDeelnemers = globals.deelnemers.length > 1;
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (globals.isOpnameActief) {
        console.log('Opname is al actief, negeer start verzoek');
        return;
      }

      if (heeftMeerdereDeelnemers && !globals.huidigeDeelnemer) {
        showNotification('Selecteer eerst een deelnemer voordat je een opname start', 'warning');
        return;
      }

      const geenDeelnemers = globals.deelnemers.length === 0;
      const enkeleDeelnemer = globals.deelnemers.length === 1;
      const magOpnemen = geenDeelnemers || enkeleDeelnemer || globals.huidigeDeelnemer;
      
      if (!magOpnemen) {
        showNotification('Selecteer eerst een deelnemer voordat je een opname start', 'warning');
        return;
      }

      const protocol = window.location.protocol;
      const isLocalhost = window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1';
      const isFileProtocol = protocol === 'file:';
      const isHttps = protocol === 'https:';

      if (!isHttps && !isLocalhost && !isFileProtocol) {
        showNotification('Spraakherkenning vereist HTTPS of lokaal gebruik', 'warning');
        return;
      }

      try {
        if (!('webkitSpeechRecognition' in window)) {
          showNotification('Spraakherkenning wordt niet ondersteund. Gebruik Chrome voor de beste ervaring.', 'warning');
          return;
        }

        if (globals.recognition) {
          try {
            globals.recognition.stop();
            globals.recognition.onresult = null;
            globals.recognition.onerror = null;
            globals.recognition.onend = null;
          } catch (e) {
            console.warn('Kon bestaande recognition niet proper stoppen:', e);
          }
          globals.recognition = null;
        }

        setTimeout(() => {
          try {
            globals.recognition = new webkitSpeechRecognition();
            
            if (isMobile) {
              globals.recognition.continuous = false;
              globals.recognition.interimResults = false;
              globals.recognition.maxAlternatives = 1;
            } else {
              globals.recognition.continuous = true;
              globals.recognition.interimResults = true;
            }
            
            globals.recognition.lang = 'nl-NL';

            const huidigeInput = document.getElementById('input').value;
            globals.permanenteTranscript = huidigeInput;

            document.getElementById('startOpname').disabled = true;
            document.getElementById('stopOpname').disabled = false;
            document.getElementById('opnameIndicator').classList.add('active');

            const deelnemerSpan = document.querySelector('.recording-deelnemer');
            if (deelnemerSpan) {
              if (globals.huidigeDeelnemer) {
                deelnemerSpan.textContent = globals.huidigeDeelnemer;
              } else if (enkeleDeelnemer) {
                deelnemerSpan.textContent = globals.deelnemers[0];
              } else {
                deelnemerSpan.textContent = 'Directe opname';
              }
            }

            globals.opnameStartTijd = Date.now();
            updateOpnameTijd();
            globals.opnameTijdTimer = setInterval(updateOpnameTijd, 1000);

            globals.laatsteInterimTranscript = '';
            globals.isOpnameActief = true;

            globals.recognition.start();
            console.log('Spraakherkenning gestart in ' + (isMobile ? 'mobiele' : 'desktop') + ' modus');

            showNotification('Opname gestart', 'success');

          } catch (error) {
            console.error('Fout bij starten spraakherkenning:', error);
            showNotification('Kon spraakherkenning niet starten: ' + error.message, 'error');
            stopOpname();
          }
        }, isMobile ? 500 : 100);

      } catch (error) {
        console.error('Kritieke fout bij opname setup:', error);
        showNotification('Er ging iets mis bij het voorbereiden van de opname', 'error');
        stopOpname();
      }
    }

    function restartMobileRecognition() {
      if (!globals.isOpnameActief) return;

      try {
        globals.recognition.stop();
      } catch (e) {
        console.warn('Kon bestaande recognition niet stoppen voor herstart:', e);
      }

      setTimeout(() => {
        if (globals.isOpnameActief) {
          try {
            globals.recognition.start();
          } catch (error) {
            console.error('Fout bij herstarten mobiele spraakherkenning:', error);
            if (error.name !== 'NotAllowedError') {
              stopOpname();
              showNotification('Spraakherkenning moest worden gestopt vanwege een fout', 'error');
            }
          }
        }
      }, 1000);
    }

    function stopOpname() {
      console.log('Stop opname aangeroepen, huidige status:', {
        isOpnameActief: globals.isOpnameActief,
        hasRecognition: !!globals.recognition
      });

      globals.isOpnameActief = false;

      if (globals.recognition) {
        try {
          globals.recognition.stop();
          console.log('Spraakherkenning gestopt');
        } catch (error) {
          console.warn('Kon spraakherkenning niet stoppen:', error);
        }
      }

      clearInterval(globals.opnameTijdTimer);
      document.getElementById('opnameTijd').textContent = '0:00';
      document.getElementById('opnameIndicator').classList.remove('active');
      document.getElementById('startOpname').disabled = false;
      document.getElementById('stopOpname').disabled = true;

      showNotification('Opname gestopt', 'info');
    }

    function updateOpnameTijd() {
      if (!globals.opnameStartTijd) return;
      
      const nu = Date.now();
      const verstrekenTijd = Math.floor((nu - globals.opnameStartTijd) / 1000);
      const minuten = Math.floor(verstrekenTijd / 60);
      const seconden = verstrekenTijd % 60;
      
      document.getElementById('opnameTijd').textContent = 
        `${minuten}:${seconden.toString().padStart(2, '0')}`;
    }

    function showHelp() {
      document.getElementById('helpModal').style.display = 'flex';
    }

    function closeHelp() {
      document.getElementById('helpModal').style.display = 'none';
    }

    document.addEventListener('click', function(event) {
      const helpModal = document.getElementById('helpModal');
      const helpModalContent = helpModal.querySelector('.help-modal-content');
      if (event.target === helpModal) {
        closeHelp();
      }
    });

    function exportTool() {
      const htmlContent = document.documentElement.outerHTML;
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'RAP TOOL NIEUW.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      showNotification('Tool succesvol geëxporteerd!', 'success');
    }

    const notificationQueue = [];
    let isProcessingNotification = false;

    function showNotification(message, type = 'info', duration = 3000) {
      notificationQueue.push({ message, type, duration });
      
      if (!isProcessingNotification) {
        processNextNotification();
      }
    }

    function processNextNotification() {
      if (notificationQueue.length === 0) {
        isProcessingNotification = false;
        return;
      }

      isProcessingNotification = true;
      const { message, type, duration } = notificationQueue.shift();

      const container = document.getElementById('notification-container');
      const activeNotifications = container.getElementsByClassName('notification');
      
      for (const notification of activeNotifications) {
        if (notification.textContent === message) {
          processNextNotification();
          return;
        }
      }

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;

      container.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => {
          if (container.contains(notification)) {
            container.removeChild(notification);
          }
          processNextNotification();
        }, 300);
      }, duration);
    }

    function toggleDarkMode() {
      const body = document.body;
      const modeText = document.querySelector('.mode-text');
      const isDarkMode = body.classList.toggle('dark-mode');
      
      if (modeText) {
        modeText.textContent = isDarkMode ? 'Licht' : 'Donker';
      }
      
      localStorage.setItem('darkMode', isDarkMode);
      
      showNotification(`${isDarkMode ? 'Donkere' : 'Lichte'} modus ingeschakeld`, 'success');
    }

    const compression = {
      compress: function(data) {
        try {
          const jsonString = JSON.stringify(data);
          return btoa(jsonString);
        } catch (error) {
          console.error('Compressie fout:', error);
          return null;
        }
      },
      
      decompress: function(compressed) {
        try {
          if (!compressed) return null;
          const jsonString = atob(compressed);
          return JSON.parse(jsonString);
        } catch (error) {
          console.error('Decompressie fout:', error);
          return null;
        }
      }
    };

    function saveToLocalStorage(key, value) {
      try {
        if (value === null || value === undefined) {
          throw new Error(`Ongeldige waarde voor ${key}`);
        }

        const compressed = compression.compress(value);
        if (!compressed) {
          throw new Error('Compressie mislukt');
        }

        const size = new Blob([compressed]).size;
        if (size > 5242880) {
          throw new Error('Data is te groot voor localStorage');
        }

        const saveData = {
          data: compressed,
          timestamp: Date.now()
        };

        localStorage.setItem(key, JSON.stringify(saveData));
        return true;
      } catch (error) {
        console.error(`Fout bij opslaan van ${key}:`, error);
        showNotification(`Fout bij opslaan van ${key}`, 'error');
        return false;
      }
    }

    function loadFromLocalStorage(key) {
      try {
        const saved = localStorage.getItem(key);
        if (!saved) return null;

        const { data, timestamp } = JSON.parse(saved);
        if (!data || !timestamp) {
          throw new Error('Ongeldige opgeslagen data');
        }

        const decompressed = compression.decompress(data);
        if (decompressed === null) {
          throw new Error('Decompressie mislukt');
        }

        return decompressed;
      } catch (error) {
        console.error(`Fout bij laden van ${key}:`, error);
        showNotification(`Fout bij laden van ${key}`, 'error');
        return null;
      }
    }

    function slaRapportageOp() {
      if (!globals.huidigeDeelnemer) return;
      
      const input = document.getElementById('input');
      if (!input) return;
      
      try {
        globals.rapportages[globals.huidigeDeelnemer] = input.value;
        saveToLocalStorage('rapportages', globals.rapportages);
        console.log(`Rapportage opgeslagen voor ${globals.huidigeDeelnemer}`);
      } catch (error) {
        console.error('Fout bij opslaan rapportage:', error);
        showNotification('Er ging iets mis bij het opslaan van de rapportage.', 'error');
      }
    }

    function setupAutoSave() {
      const input = document.getElementById('input');
      if (!input) return;
      
      input.addEventListener('input', () => {
        const genBtn = document.getElementById('genBtn');
        const heeftInput = input.value.trim() !== '';
        genBtn.disabled = !heeftInput;
        genBtn.classList.toggle('btn-disabled', !heeftInput);
        
        if (globals.huidigeDeelnemer) {
          clearTimeout(globals.autoSaveTimeout);
          globals.autoSaveTimeout = setTimeout(() => {
            slaRapportageOp();
            showNotification('Rapportage automatisch opgeslagen', 'success', 1000);
          }, 1000);
        }
      });
    }

    function wijzigDeelnemerNaam() {
      if (!globals.huidigeDeelnemer) {
        showNotification("Selecteer eerst een deelnemer.", "warning");
        return;
      }

      const nieuweNaam = prompt("Voer de nieuwe naam in voor " + globals.huidigeDeelnemer + ":");
      if (nieuweNaam && nieuweNaam.trim()) {
        const naam = nieuweNaam.trim();
        
        if (globals.deelnemers.includes(naam)) {
          showNotification("Deze naam bestaat al.", "warning");
          return;
        }

        try {
          const index = globals.deelnemers.indexOf(globals.huidigeDeelnemer);
          globals.deelnemers[index] = naam;
          
          globals.rapportages[naam] = globals.rapportages[globals.huidigeDeelnemer];
          delete globals.rapportages[globals.huidigeDeelnemer];
          
          globals.huidigeDeelnemer = naam;
          
          saveToLocalStorage('deelnemers', globals.deelnemers);
          saveToLocalStorage('rapportages', globals.rapportages);
          
          updateDeelnemersList();
          showNotification(`Naam succesvol gewijzigd naar "${naam}"`, "success");
        } catch (error) {
          console.error('Fout bij wijzigen deelnemer:', error);
          showNotification('Er ging iets mis bij het wijzigen van de naam.', 'error');
        }
      }
    }

    function verwijderDeelnemer() {
      if (!globals.huidigeDeelnemer) {
        showNotification("Selecteer eerst een deelnemer.", "warning");
        return;
      }

      const bevestig = confirm(`Weet je zeker dat je ${globals.huidigeDeelnemer} wilt verwijderen? Dit kan niet ongedaan worden gemaakt.`);
      if (bevestig) {
        try {
          const index = globals.deelnemers.indexOf(globals.huidigeDeelnemer);
          globals.deelnemers.splice(index, 1);
          delete globals.rapportages[globals.huidigeDeelnemer];
          
          saveToLocalStorage('deelnemers', globals.deelnemers);
          saveToLocalStorage('rapportages', globals.rapportages);
          
          globals.huidigeDeelnemer = '';
          document.getElementById('input').value = '';
          
          updateDeelnemersList();
          showNotification("Deelnemer succesvol verwijderd", "success");
        } catch (error) {
          console.error('Fout bij verwijderen deelnemer:', error);
          showNotification('Er ging iets mis bij het verwijderen van de deelnemer.', 'error');
        }
      }
    }

    function restartSpeechRecognition() {
      if (globals.isOpnameActief) {
        try {
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          
          if (globals.recognition) {
            try {
              globals.recognition.stop();
              
              const pauseTijd = isMobile ? 500 : 200;
              
              setTimeout(() => {
                if (isMobile && globals.recognition) {
                  const huidigeInput = document.getElementById('input').value;
                  globals.permanenteTranscript = huidigeInput;
                  
                  globals.recognition = new webkitSpeechRecognition();
                  globals.recognition.continuous = false;
                  globals.recognition.interimResults = false;
                  globals.recognition.lang = 'nl-NL';
                  
                  setupSpeechRecognitionEvents(globals.recognition);
                }
                
                globals.recognition.start();
                console.log('Spraakherkenning opnieuw gestart', { isMobile, pauseTijd });
              }, pauseTijd);
            } catch (stopError) {
              console.warn('Fout bij stoppen voor herstart:', stopError);
              globals.recognition.start();
            }
          }
        } catch (error) {
          console.error('Fout bij herstarten spraakherkenning:', error);
          stopOpname();
        }
      }
    }
    
    function setupSpeechRecognitionEvents(recognition) {
      if (!recognition) return;
      
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      let retryCount = 0;
      const maxRetries = 3;
      
      recognition.onresult = function(event) {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        console.log('Spraakherkenning resultaat ontvangen', { isMobile, resultLength: event.results.length });

        try {
          if (isMobile) {
            console.log('Mobiel resultaat verwerken');
            
            let transcript = '';
            let laatsteResultaat = event.results[event.results.length - 1];
            
            if (laatsteResultaat.isFinal) {
              transcript = laatsteResultaat[0].transcript;
              
              const huidigeInput = document.getElementById('input').value;
              if (huidigeInput && !huidigeInput.endsWith(' ')) {
                document.getElementById('input').value = huidigeInput + ' ' + transcript;
              } else {
                document.getElementById('input').value = huidigeInput + transcript;
              }
              
              console.log('Mobiele transcriptie toegevoegd:', transcript);
              
              if (globals.isOpnameActief) {
                setTimeout(function() {
                  try {
                    recognition.start();
                  } catch (error) {
                    console.warn('Kon spraakherkenning niet herstarten:', error);
                    if (error.name !== 'NotAllowedError') {
                      stopOpname();
                      showNotification('Spraakherkenning moest opnieuw worden gestart', 'info');
                    }
                  }
                }, 1000);
              }
            }
          } else {
            let interimTranscript = '';
            let finalTranscript = globals.permanenteTranscript || '';
            
            const currentResult = event.results[event.results.length - 1];
            
            if (currentResult.isFinal) {
              finalTranscript += currentResult[0].transcript + ' ';
              globals.permanenteTranscript = finalTranscript;
              retryCount = 0;
            } else {
              interimTranscript = currentResult[0].transcript;
            }
            
            document.getElementById('input').value = finalTranscript + interimTranscript;
            console.log('Desktop spraakherkenning update:', { 
              final: finalTranscript, 
              interim: interimTranscript,
              resultCount: event.results.length
            });
          }
        } catch (error) {
          console.error('Fout bij verwerken resultaat:', error);
          showNotification('Er was een probleem met de spraakherkenning', 'warning');
        }
      };
      
      recognition.onerror = function(event) {
        console.error('Spraakherkenning fout:', event.error);
        
        switch(event.error) {
          case 'no-speech':
            if (retryCount < maxRetries) {
              retryCount++;
              if (!isMobile) {
                showNotification(`Geen spraak gedetecteerd, probeer opnieuw`, 'warning');
              }
              restartSpeechRecognition();
            } else {
              showNotification('Geen spraak gedetecteerd na meerdere pogingen', 'error');
              stopOpname();
            }
            break;
          case 'audio-capture':
            showNotification('Geen microfoon gevonden of toegang geweigerd', 'error');
            stopOpname();
            break;
          case 'not-allowed':
            showNotification('Toegang tot microfoon geweigerd. Check je browser instellingen.', 'error');
            stopOpname();
            break;
          case 'network':
            showNotification('Netwerkfout bij spraakherkenning', 'error');
            stopOpname();
            break;
          default:
            showNotification('Er is een fout opgetreden met de spraakherkenning', 'error');
            stopOpname();
        }
      };
      
      recognition.onend = function() {
        if (globals.isOpnameActief) {
          if (isMobile) {
            setTimeout(() => {
              try {
                recognition.start();
              } catch (error) {
                console.warn('Kon spraakherkenning niet herstarten:', error);
                if (error.name !== 'NotAllowedError') {
                  stopOpname();
                }
              }
            }, 500);
          } else {
            restartSpeechRecognition();
          }
        }
      };
    }

    function genereerPrompt() {
      const input = document.getElementById('input').value.trim();
      if (!input) {
        showNotification('Voer eerst een observatie in', 'warning');
        return;
      }

      const keuze = document.getElementById('keuze').value;
      const methode = document.getElementById('methode').value;
      let basis = '';

      if (keuze === "taal") {
        basis = "Controleer enkel op spelling, grammatica en zinsbouw – de inhoud blijft hetzelfde.\n\n";
      } else if (keuze === "suggesties") {
        basis = "Geef 3 alternatieve formuleringen voor onderstaande tekst die duidelijker of professioneler kunnen zijn. Behoud wel de kernboodschap.\n\n";
      } else if (keuze === "combi") {
        basis = "Controleer op spelling, grammatica en zinsopbouw, zonder de betekenis of letterlijke uitspraken te veranderen. Herschrijf zinnen indien nodig voor meer duidelijkheid of betere stijl. Inhoud blijft leidend.\n\n";
      }

      basis += "Let op: vervang eventuele persoonlijke identificeerbare informatie als volledige namen door initialen of aanduidingen als 'cliënt'.\n\n";

      if (methode === "objectief") {
        globals.huidigePrompt = basis +
          "Herschrijf onderstaande observatie in objectieve stijl.\n" +
          "Vermijd interpretatie of subjectieve taal.\n\n" +
          "Tekst:\n" + input;
      } else {
        globals.huidigePrompt = basis +
          "Herschrijf onderstaande observatie volgens de SOEP-methodiek:\n" +
          "S = Subjectief (ervaring/beleving van cliënt),\n" +
          "O = Objectief (wat je ziet, hoort, ruikt of meet),\n" +
          "E = Evaluatie (jouw professionele inschatting),\n" +
          "P = Plan (wat je hiermee doet of opvolgt).\n\n" +
          "Tekst:\n" + input;
      }

      const outputElement = document.getElementById("output");
      outputElement.textContent = globals.huidigePrompt;
      outputElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      const openChatGPTBtn = document.getElementById('openChatGPTBtn');
      const copyPromptBtn = document.getElementById('copyPromptBtn');
      
      openChatGPTBtn.removeAttribute('disabled');
      copyPromptBtn.removeAttribute('disabled');
      
      openChatGPTBtn.classList.remove('btn-disabled');
      copyPromptBtn.classList.remove('btn-disabled');
      
      showNotification('Prompt gegenereerd!', 'success');
    }

    function genereerAllePrompts() {
      if (globals.deelnemers.length === 0) {
        showNotification('Er zijn nog geen deelnemers toegevoegd', 'warning');
        return;
      }

      let allePrompts = '';
      globals.deelnemers.forEach(deelnemer => {
        const rapportage = globals.rapportages[deelnemer];
        if (rapportage && rapportage.trim()) {
          allePrompts += `=== Rapportage voor ${deelnemer} ===\n\n${rapportage}\n\n`;
        }
      });

      if (!allePrompts) {
        showNotification('Geen rapportages gevonden om te verwerken', 'warning');
        return;
      }

      const keuze = document.getElementById('keuze').value;
      const methode = document.getElementById('methode').value;
      let basis = '';

      if (keuze === "taal") {
        basis = "Controleer enkel op spelling, grammatica en zinsbouw – de inhoud blijft hetzelfde.\n\n";
      } else if (keuze === "suggesties") {
        basis = "Geef 3 alternatieve formuleringen voor onderstaande tekst die duidelijker of professioneler kunnen zijn. Behoud wel de kernboodschap.\n\n";
      } else if (keuze === "combi") {
        basis = "Controleer op spelling, grammatica en zinsopbouw, zonder de betekenis of letterlijke uitspraken te veranderen. Herschrijf zinnen indien nodig voor meer duidelijkheid of betere stijl. Inhoud blijft leidend.\n\n";
      }

      basis += "Let op: vervang eventuele persoonlijke identificeerbare informatie als volledige namen door initialen of aanduidingen als 'cliënt'.\n\n";

      if (methode === "objectief") {
        basis += "Herschrijf onderstaande observaties in objectieve stijl.\n" +
                "Vermijd interpretatie of subjectieve taal.\n\n";
      } else {
        basis += "Herschrijf onderstaande observaties volgens de SOEP-methodiek:\n" +
                "S = Subjectief (ervaring/beleving van cliënt),\n" +
                "O = Objectief (wat je ziet, hoort, ruikt of meet),\n" +
                "E = Evaluatie (jouw professionele inschatting),\n" +
                "P = Plan (wat je hiermee doet of opvolgt).\n\n";
      }

      globals.huidigePrompt = basis + "Tekst:\n" + allePrompts;
      
      document.getElementById("output").textContent = globals.huidigePrompt;
      document.getElementById("output").scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      const openChatGPTBtn = document.getElementById('openChatGPTBtn');
      const copyPromptBtn = document.getElementById('copyPromptBtn');
      
      openChatGPTBtn.removeAttribute('disabled');
      copyPromptBtn.removeAttribute('disabled');
      
      openChatGPTBtn.classList.remove('btn-disabled');
      copyPromptBtn.classList.remove('btn-disabled');
      
      showNotification('Alle prompts gegenereerd!', 'success');
    }

    function openInChatGPT() {
      if (!globals.huidigePrompt) {
        showNotification('Genereer eerst een prompt', 'warning');
        return;
      }

      const chatGPTURL = 'https://chat.openai.com/';
      window.open(chatGPTURL, '_blank');
      
      kopieerPromptNaarKlembord();
    }

    function kopieerPromptNaarKlembord() {
      if (!globals.huidigePrompt) {
        showNotification('Genereer eerst een prompt', 'warning');
        return;
      }

      try {
        navigator.clipboard.writeText(globals.huidigePrompt).then(() => {
          showNotification('Prompt gekopieerd naar klembord!', 'success');
        }).catch(error => {
          console.error('Fout bij kopiëren:', error);
          showNotification('Kon prompt niet kopiëren', 'error');
        });
      } catch (error) {
        console.error('Fout bij kopiëren:', error);
        showNotification('Kon prompt niet kopiëren', 'error');
      }
    }

    function clearInput() {
      if (!globals.huidigeDeelnemer) {
        showNotification('Selecteer eerst een deelnemer', 'warning');
        return;
      }

      const input = document.getElementById('input');
      if (!input.value.trim()) {
        showNotification('Invoerveld is al leeg', 'info');
        return;
      }

      if (confirm('Weet je zeker dat je het invoerveld wilt leegmaken?')) {
        input.value = '';
        globals.rapportages[globals.huidigeDeelnemer] = '';
        saveToLocalStorage('rapportages', globals.rapportages);
        showNotification('Invoerveld gewist', 'success');
      }
    }

    function maakBackup() {
      try {
        if (!Array.isArray(globals.deelnemers)) {
          throw new Error('Ongeldige deelnemers data');
        }
        
        if (!globals.rapportages || typeof globals.rapportages !== 'object') {
          throw new Error('Ongeldige rapportages data');
        }

        const backupData = {
          deelnemers: globals.deelnemers,
          rapportages: globals.rapportages,
          huidigePrompt: globals.huidigePrompt,
          datum: new Date().toISOString(),
          versie: '1.0',
          metadata: {
            aantalDeelnemers: globals.deelnemers.length,
            aantalRapportages: Object.keys(globals.rapportages).length,
            platform: navigator.platform,
            userAgent: navigator.userAgent
          }
        };

        const backupString = JSON.stringify(backupData, null, 2);
        
        const datum = new Date().toISOString().replace(/[:.]/g, '-');
        const fileName = `rapportage_backup_${datum}.json`;

        const blob = new Blob([backupString], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        window.URL.revokeObjectURL(url);

        const msg = `Backup succesvol gemaakt met ${backupData.metadata.aantalDeelnemers} deelnemer(s) en ${backupData.metadata.aantalRapportages} rapportage(s)!`;
        showNotification(msg, 'success');
        
        return true;
      } catch (error) {
        console.error('Fout bij maken backup:', error);
        
        if (error.message === 'Ongeldige deelnemers data') {
          showNotification('Kon geen backup maken: ongeldige deelnemersdata', 'error');
        } else if (error.message === 'Ongeldige rapportages data') {
          showNotification('Kon geen backup maken: ongeldige rapportagedata', 'error');
        } else {
          showNotification('Er ging iets mis bij het maken van de backup. Probeer het opnieuw.', 'error');
        }
        
        return false;
      }
    }

    function laadBackup(input) {
      const file = input.files[0];
      if (!file) {
        showNotification('Geen bestand geselecteerd', 'warning');
        return;
      }

      if (!file.name.toLowerCase().endsWith('.json')) {
        showNotification('Alleen JSON backup bestanden worden ondersteund. Selecteer een .json bestand.', 'warning');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let backupData;
          try {
            backupData = JSON.parse(e.target.result);
          } catch (parseError) {
            showNotification('Het bestand is geen geldig JSON bestand. Controleer of je het juiste backup bestand hebt geselecteerd.', 'error');
            console.error('Parse error:', parseError);
            return;
          }

          console.log('Ontvangen backup data:', backupData);
          
          backupData = converteerBackupFormaat(backupData);
          
          const validatieResultaat = valideerBackupData(backupData);
          if (!validatieResultaat.isGeldig) {
            showNotification(`Probleem met backup data: ${validatieResultaat.fout}`, 'error');
            return;
          }

          const aantalDeelnemers = backupData.deelnemers.length;
          const aantalRapportages = Object.keys(backupData.rapportages).length;
          if (!confirm(
            `Deze backup bevat:\n` +
            `- ${aantalDeelnemers} deelnemer(s)\n` +
            `- ${aantalRapportages} rapportage(s)\n\n` +
            `Dit zal alle huidige data vervangen. Wil je doorgaan?`
          )) {
            return;
          }

          const huidigeBackup = {
            deelnemers: globals.deelnemers,
            rapportages: globals.rapportages,
            datum: new Date().toISOString(),
            versie: '1.0'
          };
          
          try {
            localStorage.setItem('laatste_backup_voor_herstel', JSON.stringify(huidigeBackup));
          } catch (backupError) {
            console.warn('Kon geen backup maken van huidige data:', backupError);
          }

          globals.deelnemers = backupData.deelnemers;
          globals.rapportages = backupData.rapportages;
          
          try {
            saveToLocalStorage('deelnemers', globals.deelnemers);
            saveToLocalStorage('rapportages', globals.rapportages);
          } catch (storageError) {
            showNotification('Waarschuwing: Kon niet alle data opslaan in localStorage. Mogelijk is de data te groot.', 'warning');
          }
          
          globals.huidigeDeelnemer = '';
          document.getElementById('input').value = '';
          
          updateDeelnemersList();
          showNotification('Backup succesvol geladen!', 'success');
          
          // Reset bestandsinput voor volgende keer
          input.value = '';
          
        } catch (error) {
          console.error('Fout bij laden backup:', error);
          showNotification('Er ging iets mis bij het laden van de backup', 'error');
          
          // Reset bestandsinput voor volgende poging
          input.value = '';
        }
      };

      reader.onerror = function() {
        console.error('Fout bij lezen bestand:', reader.error);
        showNotification('Kon het bestand niet lezen', 'error');
      };

      reader.readAsText(file);
    }

    function converteerBackupFormaat(data) {
      // Als de data al in het nieuwe formaat is, return direct
      if (data.versie && data.deelnemers && data.rapportages) {
        return data;
      }

      // Converteer oude formaten
      let geconverteerdData = {
        deelnemers: [],
        rapportages: {},
        datum: new Date().toISOString(),
        versie: '1.0'
      };

      try {
        // Probeer eerst als array van deelnemers
        if (Array.isArray(data)) {
          geconverteerdData.deelnemers = data;
          data.forEach(deelnemer => {
            geconverteerdData.rapportages[deelnemer] = '';
          });
        }
        // Anders probeer als object met deelnemers en rapportages
        else if (typeof data === 'object') {
          if (data.deelnemers) {
            geconverteerdData.deelnemers = Array.isArray(data.deelnemers) ? 
              data.deelnemers : Object.keys(data.deelnemers);
          }
          if (data.rapportages) {
            geconverteerdData.rapportages = data.rapportages;
          }
        }

        return geconverteerdData;
      } catch (error) {
        console.error('Fout bij converteren backup formaat:', error);
        throw new Error('Kon backup data niet converteren naar nieuw formaat');
      }
    }

    function valideerBackupData(data) {
      try {
        // Check basis structuur
        if (!data || typeof data !== 'object') {
          return { isGeldig: false, fout: 'Ongeldige data structuur' };
        }

        // Check deelnemers array
        if (!Array.isArray(data.deelnemers)) {
          return { isGeldig: false, fout: 'Deelnemers is geen array' };
        }

        // Check rapportages object
        if (!data.rapportages || typeof data.rapportages !== 'object') {
          return { isGeldig: false, fout: 'Rapportages is geen object' };
        }

        // Check of alle deelnemers een rapportage hebben
        for (const deelnemer of data.deelnemers) {
          if (typeof deelnemer !== 'string') {
            return { isGeldig: false, fout: 'Ongeldige deelnemer naam' };
          }
          if (!(deelnemer in data.rapportages)) {
            data.rapportages[deelnemer] = ''; // Voeg lege rapportage toe
          }
        }

        // Check of er geen overbodige rapportages zijn
        for (const deelnemer in data.rapportages) {
          if (!data.deelnemers.includes(deelnemer)) {
            delete data.rapportages[deelnemer]; // Verwijder overbodige rapportage
          }
        }

        return { isGeldig: true, fout: null };
      } catch (error) {
        console.error('Fout bij valideren backup data:', error);
        return { isGeldig: false, fout: 'Onverwachte fout bij validatie' };
      }
    }

    function resetAlles() {
      if (!confirm('Weet je zeker dat je ALLE rapportages en deelnemers wilt verwijderen? Dit kan niet ongedaan worden gemaakt!')) {
        return;
      }
      
      try {
        const backupData = {
          deelnemers: globals.deelnemers,
          rapportages: globals.rapportages,
          datum: new Date().toISOString(),
          versie: '1.0'
        };
        
        const backupString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([backupString], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        const datum = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `rapportage_backup_voor_reset_${datum}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        globals.deelnemers = [];
        globals.rapportages = {};
        globals.huidigeDeelnemer = '';
        
        localStorage.removeItem('deelnemers');
        localStorage.removeItem('rapportages');
        
        document.getElementById('input').value = '';
        document.getElementById('output').textContent = '';
        updateDeelnemersList();
        
        showNotification('Alle rapportages en deelnemers zijn verwijderd. Er is een backup gemaakt voor de zekerheid.', 'success');
      } catch (error) {
        console.error('Fout bij reset:', error);
        showNotification('Er ging iets mis bij het resetten van de data', 'error');
      }
    }

    function herstelVorigeData() {
      try {
        const laatsteBackup = localStorage.getItem('laatste_backup_voor_herstel');
        if (!laatsteBackup) {
          showNotification('Geen vorige data gevonden om te herstellen', 'warning');
          return;
        }

        const backupData = JSON.parse(laatsteBackup);
        if (!backupData.deelnemers || !backupData.rapportages) {
          showNotification('De opgeslagen backup data is ongeldig', 'error');
          return;
        }

        if (!confirm('Weet je zeker dat je de vorige data wilt herstellen? Dit overschrijft de huidige data.')) {
          return;
        }

        globals.deelnemers = backupData.deelnemers;
        globals.rapportages = backupData.rapportages;
        globals.huidigeDeelnemer = '';

        saveToLocalStorage('deelnemers', globals.deelnemers);
        saveToLocalStorage('rapportages', globals.rapportages);

        document.getElementById('input').value = '';
        updateDeelnemersList();

        localStorage.removeItem('laatste_backup_voor_herstel');

        showNotification('Vorige data succesvol hersteld', 'success');
      } catch (error) {
        console.error('Fout bij herstellen data:', error);
        showNotification('Er ging iets mis bij het herstellen van de vorige data', 'error');
      }
    }

    const domCache = {
      elements: {},
      get: function(id) {
        if (!this.elements[id]) {
          this.elements[id] = document.getElementById(id);
        }
        return this.elements[id];
      },
      clear: function() {
        this.elements = {};
      },
      refresh: function(id) {
        this.elements[id] = document.getElementById(id);
        return this.elements[id];
      }
    };

    function getElement(id) {
      return domCache.get(id);
    }

    function updateUI() {
      const input = getElement('input');
      const genBtn = getElement('genBtn');
      const copyPromptBtn = getElement('copyPromptBtn');
      const openChatGPTBtn = getElement('openChatGPTBtn');
      const genAlleBtn = getElement('genAlleBtn');
      
      const heeftInput = input && input.value.trim() !== '';
      const heeftDeelnemers = globals.deelnemers && globals.deelnemers.length > 0;
      
      if (genBtn) {
        genBtn.disabled = !heeftInput;
        genBtn.classList.toggle('btn-disabled', !heeftInput);
      }

      if (genAlleBtn) {
        genAlleBtn.disabled = !heeftInput || !heeftDeelnemers;
        genAlleBtn.classList.toggle('btn-disabled', !heeftInput || !heeftDeelnemers);
        
        if (!heeftDeelnemers) {
          genAlleBtn.title = "Voeg eerst deelnemers toe";
        } else if (!heeftInput) {
          genAlleBtn.title = "Voer eerst tekst in";
        } else {
          genAlleBtn.title = "Genereer AI-prompt voor alle deelnemers";
        }
      }

      if (copyPromptBtn && openChatGPTBtn) {
        const heeftPrompt = globals.huidigePrompt && globals.huidigePrompt.trim() !== '';
        copyPromptBtn.disabled = !heeftPrompt;
        openChatGPTBtn.disabled = !heeftPrompt;
        copyPromptBtn.classList.toggle('btn-disabled', !heeftPrompt);
        openChatGPTBtn.classList.toggle('btn-disabled', !heeftPrompt);
      }

      if (startOpname && stopOpname) {
        startOpname.disabled = globals.isOpnameActief;
        stopOpname.disabled = !globals.isOpnameActief;
      }

      if (opnameIndicator) {
        opnameIndicator.classList.toggle('active', globals.isOpnameActief);
      }
    }

    const errorTracker = {
      errors: [],
      maxErrors: 50,
      
      log: function(error, context = {}) {
        const errorInfo = {
          timestamp: new Date().toISOString(),
          message: error.message || error,
          stack: error.stack,
          type: error.name || 'Error',
          context: context,
          userAgent: navigator.userAgent,
          url: window.location.href
        };
        
        this.errors.unshift(errorInfo);
        
        if (this.errors.length > this.maxErrors) {
          this.errors.pop();
        }
        
        console.error('Error geregistreerd:', errorInfo);
        
        if (this.isErnstigeError(error)) {
          showNotification('Er is een ernstige fout opgetreden. Maak een backup van je werk.', 'error', 5000);
        }
        
        return errorInfo;
      },
      
      isErnstigeError: function(error) {
        const ernstigeTypes = [
          'QuotaExceededError',
          'NS_ERROR_DOM_QUOTA_REACHED',
          'SecurityError',
          'SyntaxError'
        ];
        return ernstigeTypes.includes(error.name) || error.message.includes('storage') || error.message.includes('quota');
      },
      
      getErrors: function() {
        return this.errors;
      },
      
      clear: function() {
        this.errors = [];
      },
      
      exportErrors: function() {
        return {
          errors: this.errors,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          url: window.location.href
        };
      }
    };

    // Event listeners setup
    function setupEventListeners() {
      // Deelnemer selectie
      document.getElementById('deelnemerSelect').addEventListener('change', function(e) {
        const deelnemer = e.target.value;
        if (deelnemer) {
          selecteerDeelnemer(deelnemer);
        }
      });

      // Deelnemer toevoegen
      document.getElementById('voegDeelnemerToe').addEventListener('click', voegDeelnemerToe);

      // Deelnemer verwijderen
      document.getElementById('verwijderDeelnemer').addEventListener('click', verwijderDeelnemer);

      // Deelnemer naam wijzigen
      document.getElementById('wijzigDeelnemerNaam').addEventListener('click', wijzigDeelnemerNaam);

      // Opname knoppen
      document.getElementById('startOpname').addEventListener('click', startOpname);
      document.getElementById('stopOpname').addEventListener('click', stopOpname);

      // Prompt generatie
      document.getElementById('genBtn').addEventListener('click', genereerPrompt);
      document.getElementById('genAlleBtn').addEventListener('click', genereerAllePrompts);

      // ChatGPT en kopieer knoppen
      document.getElementById('openChatGPTBtn').addEventListener('click', openInChatGPT);
      document.getElementById('copyPromptBtn').addEventListener('click', kopieerPromptNaarKlembord);

      // Dark mode toggle
      document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

      // Help modal
      document.getElementById('helpBtn').addEventListener('click', showHelp);
      document.getElementById('closeHelp').addEventListener('click', closeHelp);

      // Changelog modal
      document.getElementById('changelogBtn').addEventListener('click', showChangelog);
      document.getElementById('closeChangelog').addEventListener('click', closeChangelog);

      // Reset en herstel knoppen
      document.getElementById('resetAlles').addEventListener('click', resetAlles);
      document.getElementById('herstelVorigeData').addEventListener('click', herstelVorigeData);

      // Backup knoppen
      document.getElementById('maakBackup').addEventListener('click', maakBackup);
      document.getElementById('laadBackupInput').addEventListener('change', function(e) {
        laadBackup(this);
      });

      // Input veld wissen
      document.getElementById('clearInput').addEventListener('click', clearInput);

      // Modals sluiten bij klik buiten
      window.addEventListener('click', function(event) {
        const helpModal = document.getElementById('helpModal');
        const changelogModal = document.getElementById('changelog-modal');
        if (event.target === helpModal) {
          closeHelp();
        }
        if (event.target === changelogModal) {
          closeChangelog();
        }
      });

      // Toetsenbord snelkoppelingen
      document.addEventListener('keydown', function(event) {
        if (event.altKey) {
          switch(event.key) {
            case 'g':
              event.preventDefault();
              if (!document.getElementById('genBtn').disabled) {
                genereerPrompt();
              }
              break;
            case 'a':
              event.preventDefault();
              genereerAllePrompts();
              break;
            case 'o':
              event.preventDefault();
              if (!document.getElementById('openChatGPTBtn').disabled) {
                openInChatGPT();
              }
              break;
            case 's':
              event.preventDefault();
              if (!document.getElementById('startOpname').disabled) {
                startOpname();
              }
              break;
            case 'p':
              event.preventDefault();
              if (!document.getElementById('stopOpname').disabled) {
                stopOpname();
              }
              break;
            case 'm':
              event.preventDefault();
              toggleDarkMode();
              break;
            case 'r':
              event.preventDefault();
              if (globals.huidigeDeelnemer) {
                clearInput();
              }
              break;
            case 'c':
              event.preventDefault();
              if (!document.getElementById('copyPromptBtn').disabled) {
                kopieerPromptNaarKlembord();
              }
              break;
          }
        }
      });
    }

    // Initialisatie bij laden pagina
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Cache vaak gebruikte elementen
        ['input', 'genBtn', 'copyPromptBtn', 'openChatGPTBtn', 'deelnemerSelect', 
         'startOpname', 'stopOpname', 'output', 'opnameIndicator'].forEach(id => {
          domCache.get(id);
        });

        // Laad opgeslagen data
        const opgeslagenDeelnemers = loadFromLocalStorage('deelnemers');
        const opgeslagenRapportages = loadFromLocalStorage('rapportages');

        if (opgeslagenDeelnemers) {
          globals.deelnemers = opgeslagenDeelnemers;
        }

        if (opgeslagenRapportages) {
          globals.rapportages = opgeslagenRapportages;
        }

        // Update UI
        updateDeelnemersList();
        setupEventListeners();
        
        // Check dark mode voorkeur
        if (localStorage.getItem('darkMode') === 'true') {
          document.body.classList.add('dark-mode');
          const modeText = document.querySelector('.mode-text');
          if (modeText) {
            modeText.textContent = 'Licht';
          }
        }

        // Registreer service worker
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('service-worker.js')
            .then(registration => {
              console.log('Service Worker geregistreerd:', registration);
            })
            .catch(error => {
              console.error('Service Worker registratie mislukt:', error);
            });
        }

        showNotification('Applicatie succesvol geladen', 'success');
      } catch (error) {
        console.error('Fout bij initialisatie:', error);
        showNotification('Er ging iets mis bij het laden van de applicatie', 'error');
      }
    });
  </script>
</body>
</html> 